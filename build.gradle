plugins {
    id 'jacoco'
    id 'com.github.kt3k.coveralls' version '2.6.3'
    id "org.sonarqube" version "2.2"
}

apply plugin: 'java'
allprojects {
    apply plugin: 'java'
    apply plugin: 'jacoco'
}

group 'com.tolpp.memguard'
version '0.1-SNAPSHOT'


repositories {
    mavenCentral()
}

coveralls {
    jacocoReportPath = "${buildDir}/reports/coverage/coverageReport.xml"
    subprojects.each { p ->
        sourceDirs.add(p.getPath())
    }
}

task coverageReport(type: JacocoReport) {
    dependsOn = subprojects.test
    sourceSets sourceSets.main

    def execFiles = []
    subprojects.each { p ->
        def coverageFileLocation = "$p.buildDir/jacoco/test.exec"
        additionalSourceDirs files((Set<File>) p.sourceSets.main.allJava.srcDirs)
        additionalClassDirs((FileCollection) p.sourceSets.main.output)
        if (new File(coverageFileLocation).exists()) {
            execFiles << coverageFileLocation
        }
    }

    logger.info('Aggregate coverage files :', execFiles)
    executionData = files(execFiles)

    reports {
        xml.enabled = true
        xml.destination = "${buildDir}/reports/coverage/coverageReport.xml"
        csv.enabled = false
        html.enabled = false
    }

}

